# ~/.config/tmux/tmux.conf
#
# ▄▄▄█████▓ ███▄ ▄███▓ █    ██ ▒██   ██▒
# ▓  ██▒ ▓▒▓██▒▀█▀ ██▒ ██  ▓██▒▒▒ █ █ ▒░
# ▒ ▓██░ ▒░▓██    ▓██░▓██  ▒██░░░  █   ░
# ░ ▓██▓ ░ ▒██    ▒██ ▓▓█  ░██░ ░ █ █ ▒
#   ▒██▒ ░ ▒██▒   ░██▒▒▒█████▓ ▒██▒ ▒██▒
#   ▒ ░░   ░ ▒░   ░  ░░▒▓▒ ▒ ▒ ▒▒ ░ ░▓ ░
#     ░    ░  ░      ░░░▒░ ░ ░ ░░   ░▒ ░
#   ░      ░      ░    ░░░ ░ ░  ░    ░
#                 ░      ░      ░    ░

##### ── Prefix Key ────────────────────────────────────────────────
# Use Ctrl-Space instead of the default Ctrl-b.
unbind C-b
set -g prefix C-Space
bind C-Space send-prefix

##### ── Terminal & Colors ─────────────────────────────────────────
# Use tmux-256color for better terminfo support inside tmux.
set -g default-terminal "tmux-256color"

# Enable truecolor + italics for common terminals (Alacritty, xterm).
set -as terminal-features "alacritty:RGB"
set -ga terminal-overrides ',alacritty:Tc,sitm=\E[3m'
set -as terminal-features "xterm-256color:RGB"
set -ga terminal-overrides ',xterm-256color:Tc,sitm=\E[3m'

##### ── History & Modes ───────────────────────────────────────────
set -g history-limit 25000    # Scrollback lines inside tmux
set -g mode-keys vi           # Vi-style keys in copy mode
set -g status-keys emacs      # Emacs-style keys at the command prompt
set -s escape-time 0          # Instant <Esc> (nice for Vim)
set -g display-time 0         # Status messages stay until a key is pressed

##### ── Mouse (Global Behavior) ───────────────────────────────────
# NOTE: tmux fully owns mouse drags in panes (including Vim/vifm).
# - Scroll wheel: scrolls tmux history
# - Left-drag: enters copy-mode and selects (see bindings below)

set -g mouse on               # Enable mouse support

# Focus pane on mouse down.
bind -T root MouseDown1Pane select-pane

# On drag:
# - If already in a mode (copy-mode, etc.), pass the drag to that mode.
# - Otherwise, enter copy-mode with mouse (-M) and start a selection.
bind -T root MouseDrag1Pane if -F '#{pane_in_mode}' \
  'send-keys -M' \
  'copy-mode -M'

##### ── Copy Mode (Vi Style + Mouse) ──────────────────────────────
# Keyboard selection in copy-mode (vi-style).
unbind -T copy-mode-vi v
bind   -T copy-mode-vi v       send -X begin-selection
bind   -T copy-mode-vi Escape  send -X cancel

# Mouse selection in copy-mode:
# - Drag to adjust selection
# - Release to copy to system clipboard and exit copy-mode
bind -T copy-mode-vi MouseDrag1Pane      send -X begin-selection
bind -T copy-mode-vi MouseDragEnd1Pane   send -X copy-pipe-and-cancel "pbcopy"

##### ── Clipboard Integration ─────────────────────────────────────
# 1) Copy-mode 'y' → system clipboard (platform-aware)
#    Workflow:
#      prefix + [ → enter copy-mode
#      v to begin selection (or drag with mouse)
#      y to yank to system clipboard

unbind -T copy-mode-vi y

# macOS (pbcopy)
if-shell 'command -v pbcopy >/dev/null' \
  'bind -T copy-mode-vi y send -X copy-pipe-and-cancel "pbcopy"'

# Linux (X11 with xsel)
if-shell '! command -v pbcopy >/dev/null && command -v xsel >/dev/null' \
  'bind -T copy-mode-vi y send -X copy-pipe-and-cancel "xsel -i -b"'

# Linux (X11 with xclip)
if-shell '! command -v pbcopy >/dev/null && ! command -v xsel >/dev/null && command -v xclip >/dev/null' \
  'bind -T copy-mode-vi y send -X copy-pipe-and-cancel "xclip -i -selection clipboard"'

# Enable OSC-52 so copies can escape over SSH in supporting terminals.
set -g set-clipboard on

# 2) Re-export last tmux buffer → system clipboard (outside copy-mode)
#    - prefix + y
#    - Useful if the clipboard got clobbered by another app.
bind y run -b 'tmux save-buffer - | { pbcopy 2>/dev/null || xsel -i -b 2>/dev/null || xclip -i -selection clipboard >/dev/null 2>&1; }'

##### ── Indexing ──────────────────────────────────────────────────
set -g base-index 1           # Windows start at 1
set -g pane-base-index 1      # Panes start at 1

##### ── Status Line ───────────────────────────────────────────────
set -g status on
set -g status-interval 60     # Refresh every 60 seconds
set -g status-style "bg=colour236,fg=colour250"

setw -g window-status-separator ""
setw -g window-status-last-style underscore

set -g status-left-length 100
set -g status-right-length 100

# Left: session name
set -g status-left "#[bold][#S]"

# Window list formatting
setw -g window-status-format          "#[fg=colour243] #I:#W "
setw -g window-status-current-format  "#[fg=colour250][#I:#W]"

# Right: uptime (simplified), time, host
set -g status-right '#(uptime | rev | cut -d ":" -f1 | rev | tr -d ",") | %H:%M [#h]'

##### ── Navigation & Splits ───────────────────────────────────────
# Pane navigation with Alt-h/j/k/l (matches Vim-style movement).
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

# Split panes in the current pane's working directory.
bind v split-window -h -c "#{pane_current_path}"
bind s split-window -v -c "#{pane_current_path}"

# Resize panes with repeatable keys (prefix + H/J/K/L).
bind -r H resize-pane -L 2
bind -r J resize-pane -D 2
bind -r K resize-pane -U 2
bind -r L resize-pane -R 2

##### ── Session/Window Behavior ───────────────────────────────────
set -g renumber-windows on    # Renumber windows after closing one
set -g detach-on-destroy off  # Stay attached if the current session ends
set -g automatic-rename on    # Name windows based on running command
set -g allow-rename off       # Ignore apps trying to rename windows
set -g focus-events on        # Send focus in/out events to apps

# Window sizing policy:
# - aggressive-resize off: layout based on largest attached client (default)
# - turn on if you always want windows to shrink to the smallest client.
setw -g aggressive-resize off

##### ── Utilities ─────────────────────────────────────────────────
# Reload tmux config without restarting tmux.
# prefix + r
bind r source-file ~/.config/tmux/tmux.conf \; display-message "TMUX CONFIG RELOADED"
